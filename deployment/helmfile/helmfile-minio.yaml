bases:
  - environments.yaml

---

{{- $helmChartVersionsDir := requiredEnv "HELM_CHART_VERSIONS_DIR" }}
{{- $secretsDir := requiredEnv "SECRETS_DIR" }}

repositories:
  - name: idc
    url: {{ (.Values.idcHelmRepository).url | quote }}
    oci: true
  - name: minio
    url: https://charts.min.io/

releases:

{{- if $.Values.global.enabled }}
{{- if $.Values.global.idcCoreServices.enabled }}

  {{- if $.Values.global.minio.enabled }}
  # Helmfile is used to install Minio for development only.
  # For simplicity, standard Kubernetes Secrets are used, not Vault.
  # See https://github.com/minio/minio/tree/master/helm/minio#installing-the-chart
  - name: minio
    namespace: idcs-system
    kubeContext: {{ $.Values.global.kubeContext }}
    labels:
      component: minio
      geographicScope: global
      environmentName: {{ $.Values.global.environmentName }}
      applicationName: minio
      kubeContext: {{ $.Values.global.kubeContext }}
    chart: minio/minio
    version: 5.0.11
    values:
      - resources:
          requests:
            memory: 512Mi
      - replicas: 1
      - persistence:
          enabled: {{ $.Values.global.minio.persistence.enabled }}
          size: {{ $.Values.global.minio.persistence.size }}
      - mode: standalone
      - rootUser: minio
      - rootPassword: {{ readFile (print $secretsDir "/minio_root_password") | quote }}
      - buckets:
          - name: fs-bucket-kind
            policy: none
            purge: false
  {{- end }}

{{- end }}
{{- end }}
