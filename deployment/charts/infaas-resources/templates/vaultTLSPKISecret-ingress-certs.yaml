# https://developer.hashicorp.com/vault/docs/platform/k8s/vso/api-reference#vaultpkisecret

apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultPKISecret
metadata:
  name: vault-pki-ingress-certificates
  namespace: istio-system
spec:
  vaultAuthRef: vault-istio-ingress-auth
  mount: {{ .Values.region -}}-maas-ca
  role: {{ .Values.region -}}-maas-istio-ingressgateway
  destination:
    create: true
    name: ingress-certs
    type: kubernetes.io/tls
    transformation:
      templates:
        ca.crt:
          text: |
            {{`{{- printf "%s" (get .Secrets "issuing_ca") -}}`}}
        tls.crt:
          text: |
            {{`{{- printf "%s" (get .Secrets "certificate") -}}`}}
        tls.key:
          text: |
            {{`{{- printf "%s" (get .Secrets "private_key") -}}`}}

  commonName: maas-dispatcher.idcstage.intel.com # TODO as Vishnu what's the value for prod
  format: pem
  revoke: false
  clear: true
  expiryOffset: 15s
#  ttl: 1m # TODO set to 1h after testing
