{{ if .Values.serviceMonitor.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-general
spec:
  provider:
    vault:
      server: {{ $.Values.vault.service | quote }}
      auth:
        jwt:
          kubernetesServiceAccountToken:
            serviceAccountRef:
              name: {{ include "idc-common.serviceAccountName" . }}
              audiences:
                - https://kubernetes.default.svc.cluster.local
          path: {{ (.Values.vault).authPath | trimPrefix "auth/" | quote }}
          role: "{{ include "idc-common.serviceAccountName" . }}-role"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "idc-common.fullname" . }}-prometheus
  namespace: {{ include "idc-common.namespace" . }}
spec:
  target:
    name: {{ include "idc-common.fullname" . }}-prometheus
    template:
      type: Opaque
  data:
    - secretKey: username
      remoteRef:
        key: controlplane/data/{{.Values.region}}-maas-gateway/prometheus
        property: username
    - secretKey: password
      remoteRef:
        key: controlplane/data/{{.Values.region}}-maas-gateway/prometheus
        property: password
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-general
{{- end }}