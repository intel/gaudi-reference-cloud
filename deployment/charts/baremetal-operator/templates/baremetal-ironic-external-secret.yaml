# Alternate option to get ca chain(ca.crt):
# 1) Add `format: pem_bundle` as a parameter under kind: VaultDynamicSecret spec
# https://developer.hashicorp.com/vault/api-docs/secret/pki#format
# 2) use `filterPEM` helper function in the secret template to remove the key from the pem pem_bundle
# https://external-secrets.io/v0.8.1/guides/templating/#filter-pem-blocks
# Example: tls.crt: "{{ `{{.certificate | filterPEM \"CERTIFICATE\" }}` }}"
{{- if .Values.enableTLSandAuth -}}
{{- if .Values.useVaultPKI }}
{{- $signPath := printf "%s/%s" .Values.vault.pkiSignPathPrefix (splitList "-" .Release.Name | initial | initial | join "-") }}
{{- $featureList := list "ironic" "ironic-inspector" "mariadb" }}
{{- range $feature := $featureList }}
---
apiVersion: generators.external-secrets.io/v1alpha1
kind: VaultDynamicSecret
metadata:
  name: {{ $feature }}
  namespace: {{ $.Release.Namespace }}
spec:
  path: "{{ $signPath }}"
  method: "POST"
  parameters:
  {{- if eq $feature "ironic" }}
    common_name: "{{ $.Values.ironicEnvConfigMap.ironicIP }}:6385"
    ip_sans: "127.0.0.1,{{ $.Values.ironicEnvConfigMap.ironicIP }}"
  {{- else if  eq $feature "ironic-inspector" }}
    common_name: "{{ $.Values.ironicEnvConfigMap.ironicIP }}:5050"
    ip_sans: "127.0.0.1,{{ $.Values.ironicEnvConfigMap.ironicIP }}"
  {{- else }}
    common_name: "127.0.0.1"
    ip_sans: "127.0.0.1,{{ $.Values.ironicEnvConfigMap.ironicIP }}"
  {{- end }}
  provider:
    server: {{ $.Values.vault.service | quote }}
    auth:
      jwt:
        kubernetesServiceAccountToken:
          serviceAccountRef:
            name: baremetal-operator-ironic
            audiences:
            - https://kubernetes.default.svc.cluster.local
        path: cluster-auth
        role: {{ $.Release.Name }}-ironic-role
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $feature }}
  namespace: {{ $.Release.Namespace }}
spec:
  refreshInterval: {{ $.Values.vault.refreshInterval | quote }}
  target:
    name: {{ $feature }}-cert
    template:
      type: kubernetes.io/tls
      engineVersion: v2
      data:
        tls.crt: "{{ `{{.certificate}}` }}"
        tls.key: "{{ `{{.private_key}}` }}"
        ca.crt: |
          {{ `{{- range $v := (.ca_chain | fromJson) }}` }}
          {{ `{{- printf "%s\n" $v }}` }}
          {{ `{{- end }}` }}
        private_key_type: "{{ `{{.private_key_type}}` }}"
        issuing_ca: "{{ `{{.issuing_ca}}` }}"
        serial_number: "{{ `{{.serial_number}}` }}"
        expiration: "{{ `{{.expiration}}` }}"
        original_ca_chain: "{{ `{{.ca_chain}}` }}"
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: VaultDynamicSecret
        name: {{ $feature }}
{{- end }}
{{- end }}
{{- end }}
