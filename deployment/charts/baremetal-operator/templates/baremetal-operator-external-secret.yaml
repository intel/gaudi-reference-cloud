# Alternate option to get ca chain:
# 1) Add `format: pem_bundle` as a parameter under kind: VaultDynamicSecret spec
# https://developer.hashicorp.com/vault/api-docs/secret/pki#format
# 2) use `filterPEM` helper function in the secret template to remove the key from the pem pem_bundle
# https://external-secrets.io/v0.8.1/guides/templating/#filter-pem-blocks
# Example: tls.crt: "{{ `{{.certificate | filterPEM \"CERTIFICATE\" }}` }}"
{{- if not .Values.deployStandaloneIronic -}}
{{- if .Values.useVaultPKI }}
{{- $signPath := printf "%s/%s" .Values.vault.pkiSignPathPrefix (splitList "-" .Release.Name | initial | initial | join "-") }}
---
apiVersion: generators.external-secrets.io/v1alpha1
kind: VaultDynamicSecret
metadata:
  name: baremetal-operator-serving-cert
  namespace: {{ $.Release.Namespace }}
spec:
  path: "{{ $signPath }}"
  method: "POST"
  parameters:
    common_name: "baremetal-operator-webhook-service.{{ $.Release.Namespace }}.svc.cluster.local"
    alt_names: "baremetal-operator-webhook-service.{{ $.Release.Namespace }}.svc, baremetal-operator-webhook-service.{{ $.Release.Namespace }}.svc.cluster.local"
  provider:
    server: {{ $.Values.vault.service | quote }}
    auth:
      jwt:
        kubernetesServiceAccountToken:
          serviceAccountRef:
            name: baremetal-operator
            audiences:
            - https://kubernetes.default.svc.cluster.local
        path: cluster-auth
        role: {{ $.Release.Name }}-role
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: baremetal-operator-serving-cert
  namespace: {{ $.Release.Namespace }}
spec:
  refreshInterval: {{ $.Values.vault.refreshInterval | quote }}
  target:
    name: bmo-webhook-server-cert
    template:
      templateFrom:
      - target: Annotations
        literal: "cert-manager.io/allow-direct-injection: true"
      type: kubernetes.io/tls
      engineVersion: v2
      data:
        tls.crt: "{{ `{{.certificate}}` }}"
        tls.key: "{{ `{{.private_key}}` }}"
        ca.crt: |
          {{ `{{- range $v := (.ca_chain | fromJson) }}` }}
          {{ `{{- printf "%s\n" $v }}` }}
          {{ `{{- end }}` }}
        private_key_type: "{{ `{{.private_key_type}}` }}"
        issuing_ca: "{{ `{{.issuing_ca}}` }}"
        serial_number: "{{ `{{.serial_number}}` }}"
        expiration: "{{ `{{.expiration}}` }}"
        original_ca_chain: "{{ `{{.ca_chain}}` }}"
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: VaultDynamicSecret
        name: baremetal-operator-serving-cert
{{- end }}
{{- end }}
