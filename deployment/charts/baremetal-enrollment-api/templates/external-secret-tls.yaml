{{- if .Values.apiServer.ingress.enabled -}}
{{- if .Values.apiServer.ingress.externalSecret.enabled }}
apiVersion: generators.external-secrets.io/v1alpha1
kind: VaultDynamicSecret
metadata:
  name: {{ include "baremetal-enrollment-api.fullname" . }}
  namespace: {{ .Release.Namespace }}
spec: 
  path: {{ (.Values.apiServer.ingress).issueCa }}/issue/{{ include "baremetal-enrollment-api.fullname" . }}
  method: "POST"
  parameters:
    common_name: {{ index (index $.Values.apiServer.ingress.tls 0).hosts 0 | quote }}
  provider:
    server: {{ $.Values.apiServer.config.vaultAddress | quote }}
    auth:
      jwt:
        kubernetesServiceAccountToken:
          serviceAccountRef:
            name: {{ include "baremetal-enrollment-api.fullname" . }}
            audiences:
            - https://kubernetes.default.svc.cluster.local
        path: {{ (.Values.apiServer.config).vaultAuthPath | trimPrefix "auth/" | quote }}
        role: "{{ include "baremetal-enrollment-api.fullname" . }}-role"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "baremetal-enrollment-api.fullname" . }}
  namespace: {{ .Release.Namespace }}
spec:
  refreshInterval: {{ $.Values.apiServer.ingress.externalSecret.refreshInterval | quote }}
  target:
    name: enrollment-tls
    template:
      templateFrom:
      - target: Annotations
        literal: "cert-manager.io/allow-direct-injection: true"
      type: kubernetes.io/tls
      engineVersion: v2
      data:
        # tls.crt must include the server certificate and the CA chain. The root CA is optional.
        tls.crt: |
          {{ `{{ .certificate }}` }}
          {{ `{{- range $v := (.ca_chain | fromJson) }}` }}
          {{ `{{ $v }}` }}
          {{ `{{- end }}` }}
        tls.key: "{{ `{{ .private_key }}` }}"
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: VaultDynamicSecret
        name: {{ include "baremetal-enrollment-api.fullname" . }}
{{- end }}
{{- end }}
