apiVersion: v1
kind: ConfigMap
metadata:
  name: sso-pipeline-roles
data:
  sso_pipeline_roles.py: |
    from django.contrib.auth.models import Group
    def set_role(response, user, backend, *args, **kwargs):
      client_id = '85e667df-f13a-4e1e-bf7b-540443c1e848'
      roles = ["IDC_Netbox_RO", "IDC_Netbox_Admin" ]
      try:
        roles = response['resource_access'][client_id]['roles']
      except KeyError:
        pass
        if 'IDC_Netbox_Admin' in roles:
            user.is_staff = True
            user.is_superuser = True

        elif 'IDC_Netbox_RO' in roles:
            user.is_superuser = True

        else:
            pass
      user.save()
      groups = Group.objects.all()
      for group in groups:
        try:
          if group.name in roles:
            group.user_set.add(user)
          else:
            group.user_set.remove(user)
        except Group.DoesNotExist:
          continue
