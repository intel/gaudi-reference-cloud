{
  "metadata": {
    "name": "load-vm-<<index>>"
  },
  "spec": {
    "availabilityZone": "us-dev-1a",
    "instanceType": "vm-icp-gaudi2-1",
    "machineImage": "ubuntu-20.04-gaudi2-v1.13-vm-v1",
    "runStrategy": "RerunOnFailure",
    "sshPublicKeyNames": [
      "user2@acme.com"
    ],
    "interfaces": [
      {
        "name": "eth0",
        "vNet": "us-dev-1a-default"
      }
    ],
    "userData": "#cloud-init\nwrite_files:\n  - path: /tmp/Dockerfile\n    permissions: '0777'\n    content: |\n      # Use the base image\n      FROM vault.habana.ai/gaudi-docker/1.13.0/ubuntu20.04/habanalabs/pytorch-installer-2.1.0:1.13.0-463-20231206\n\n      # Set environment variables\n      ENV HABANA_VISIBLE_DEVICES=all\n      ENV OMPI_MCA_btl_vader_single_copy_mechanism=none\n\n      # Add capability\n      RUN apt-get update && apt-get install -y libcap2\n      RUN setcap cap_sys_nice=ep /usr/bin/python3.8\n\n      # Clone the repository and navigate to the directory\n      RUN git clone https://github.com/HabanaAI/Model-References.git && \\\n          cd Model-References/PyTorch/examples/computer_vision/hello_world/ && \\\n          git reset --hard 0b475f02e1b64691b729e012776e4d8a255431fb\n\n      # Set PYTHONPATH\n      ENV PYTHONPATH=$PYTHONPATH:/Model-References\n\n      # Set Python executable path\n      ENV PYTHON=/usr/bin/python3.8\n\n      # Define the command to execute the training load\n      CMD [\"sh\", \"-c\", \"export PYTHONPATH=$PYTHONPATH:/Model-References && \\\n                         export PYTHON=/usr/bin/python3.8 && \\\n                         $PYTHON /Model-References/PyTorch/examples/computer_vision/hello_world/mnist.py --batch-size=64 --epochs=15 --lr=1.0 --gamma=0.7 --hpu --autocast\"]\n  - path: /tmp/run_container.sh\n    permissions: '0777'\n    content: |\n      #!/bin/bash\n\n      # Build the Docker image\n      docker build -t my_pytorch_image -f /tmp/Dockerfile . > /tmp/dockeroutput1.txt 2>&1\n\n      # Run a container using the built image\n      docker run --runtime=habana -e HABANA_VISIBLE_DEVICES=all -e OMPI_MCA_btl_vader_single_copy_mechanism=none \\\n                 --cap-add=sys_nice --net=host --ipc=host my_pytorch_image >/tmp/dockeroutput2.txt 2>&1"

  }
}
