# See https://cloudinit.readthedocs.io/en/latest/
apiVersion: v1
kind: Secret
metadata:
  labels:
    harvesterhci.io/cloud-init-template: harvester
  name: "{{ $.Release.Name }}"
type: secret
stringData:
  networkdata: |
    #cloud-config
    network:
      version: 1
      config:
        - type: physical
          name: enp1s0
          subnets:
            - type: static
              address: "{{ $.Values.network.subnet0.address }}"
              gateway: "{{ $.Values.network.subnet0.gateway }}"
              dns_nameservers: {{ $.Values.network.dns_nameservers | mustToJson }}
            - type: static
              address: "{{ $.Values.network.subnet1.address }}"
  userdata: |
    #cloud-config
    write_files:
      - path: /etc/apt/apt.conf.d/00-proxy
        permissions: "640"
        owner: root
        content: |
          Acquire::http::Proxy "http://internal-placeholder.com:912";
          Acquire::https::Proxy "http://internal-placeholder.com:912";
      - path: /etc/rc.local
        permissions: "755"
        owner: root
        content: |
          #!/bin/bash
          # Enable IP masquerade NAT to allow outbound access from instances.
          iptables -t nat --append POSTROUTING --out-interface enp1s0 -j MASQUERADE
          iptables --append FORWARD --in-interface enp1s0 -j ACCEPT
          sysctl -w net.ipv4.conf.all.forwarding=1
    package_update: false
    runcmd:
      - - apt
        - update
      - - apt
        - install
        - qemu-guest-agent
        - '-y'
      - - systemctl
        - '--now'
        - enable
        - qemu-guest-agent
      - /etc/rc.local
    ssh_keys:
      rsa_private: {{ $.Values.ssh.ssh_host_rsa_key | trim | quote }}
      rsa_public: {{ $.Values.ssh.ssh_host_rsa_key_pub | trim | quote }}
      ecdsa_private: {{ $.Values.ssh.ssh_host_ecdsa_key | trim | quote }}
      ecdsa_public: {{ $.Values.ssh.ssh_host_ecdsa_key_pub | trim | quote }}
      ed25519_private: {{ $.Values.ssh.ssh_host_ed25519_key | trim | quote }}
      ed25519_public: {{ $.Values.ssh.ssh_host_ed25519_key_pub | trim | quote }}
    ssh_authorized_keys: {{ $.Values.defaultUser.ssh_authorized_keys | toJson }}
    users:
      - default
      {{- range $userName, $v := $.Values.users }}
      - name: {{ $userName | quote }}
        ssh_authorized_keys: {{ $v.ssh_authorized_keys | toJson }}
      {{- end }}
