---

# Network need to be created as root; primarily due
# to the restriction on creating network interfaces

- name: Create libvirt network for vlan{{ vlan_num }}
  block:
  - name: Check if libvirt network for vlan{{ vlan_num }} is already running...
    ansible.builtin.shell:
      cmd: >
        virsh net-info "vlan{{ vlan_num }}"
    register: netstate_result
    failed_when: "netstate_result.rc == 0"
    changed_when: "netstate_result.rc != 0"
  - name: Create temporary network file
    become: true
    ansible.builtin.tempfile:
      state: file
      suffix: temp
    register: vlan_net_tempfile
  - name: Define network XML for vlan{{ vlan_num }}
    ansible.builtin.template:
      src: net-vlan.xml.j2
      dest: "{{ vlan_net_tempfile.path }}"
      owner: root
      group: root
      mode: '0644'
      backup: false
  - name: define libvirt network for vlan{{ vlan_num }}
    command: virsh net-define {{ vlan_net_tempfile.path }}
    register: result
    changed_when: "result.rc != 0"
  - name: start libvirt network for vlan{{ vlan_num }}
    command: virsh net-start vlan{{ vlan_num }}
    register: result
    changed_when: "result.rc != 0"
  - name: Setting autostart libvirt network for vlan{{ vlan_num }}
    command: virsh net-autostart vlan{{ vlan_num }}
    register: result
    changed_when: "result.rc != 0"
  always:
    - name: Clean up the temporary file
      ansible.builtin.file:
        path: "{{ vlan_net_tempfile.path }}"
        state: absent
      when: vlan_net_tempfile.path is defined
  vars:
    ansible_network_os: 'ios'
  become: true
