.. _vmaas_gaudi2_firmware_upgrade_procedure :

VMaaS Gaudi2 Firmware Upgrade Procedure
############################################

This document outlines the procedure used to upgrade the IDC-VMaaS Gaudi2 firmware to the version, **1.15.0**.
  
   .. note::
      This document may serve as a reference for additional version in other environments


Prerequisites
*******************

* IDC - DEVELOPER (AGS Roles)
* Admin Credentials for the Harvester Box and UI
* Get the Debian archive files **habanalabs-firmware-odm-1.13.0-463.amd64.deb** and **habanalabs-firmware-odm-1.15.0-479.amd64.deb** from the EPS Cloud and Operations or BMaaS team

Communicatons & upgrade window
*********************************

* The upgrade team identifies the nodes designated for the upgrade.
* The Product Management team informs the respective users to evacuate their VMs within a designated timeframe, which is established by the Product Management team.
* The Product Management team and SRE team notify all stakeholders that the IDC-VMaaS Gaudi2 will operate at reduced capacity.
* The upgrade team disables the new Gaudi2 VMs scheduling by removing the specific Gaudi2 instance-type label.

Execute the Upgrade
****************************
#. Hide the existing VM image (1.13.0) and configure new VM image (1.15.0).

#. Perform following for each selected Node

- Evict all existing VMs.

- Enable|INTG2| VM Scheduling and immediately launch all 8 VMs, which allows for controlling the upgrade process one VM at a time:

- Login to Harvetser Box and Disable write-protect

   - Wiwynn Devices
      .. code-block:: bash

         #!/usr/bin/bash

         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x00 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x00 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x01 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x01 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x02 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x02 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x03 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x03 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x04 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x04 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x05 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x05 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x06 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x06 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x07 0x25 0x01 0x8 0x2e
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x07 0x25 0x01 0x8 0x2e
   
   - Supermicro Devices
      .. code-block:: bash

       #!/usr/bin/bash

         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x40 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x40 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x41 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x41 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x42 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x42 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x43 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x43 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x44 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x44 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x45 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x45 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x46 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x46 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x47 2 0x4a 1 0x8 0x2e
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x47 2 0x4a 1 0x8 0x2e

- Perform following for each VM

   - SCP the Debian archive file **habanalabs-firmware-odm-1.15.0-479.amd64.deb** to the VM
   - Login into VM and Execute

      .. code-block:: bash

         #!/usr/bin/bash

         sudo dpkg -i habanalabs-firmware-odm-1.15.0-479.amd64.deb
         echo "Removing Modules..."
         sudo modprobe -r habanalabs
         sudo modprobe -r habanalabs_cn
         sudo modprobe -r habanalabs_ib
         sudo modprobe -r habanalabs_en
         sleep 60
         echo "Reseting the device..."
         sudo hl-fw-loader -R -y
         sleep 60
         echo "Updating eRom..."
         sudo hl-fw-loader -y -f /lib/firmware/habanalabs/gaudi2/gaudi2-agent-fw_loader-fit_erom.itb
         sleep 60
         echo "Updating SPI..."
         sudo hl-fw-loader -y
         sleep 60
         echo "Loading the drivers ..."
         sudo modprobe habanalabs_en
         sudo modprobe habanalabs_cn
         sudo modprobe habanalabs_ib
         sudo modprobe habanalabs

   - Verification

      - Execute hl-smi --fw-versions and confirm that the driver version displayed in the hl-smi --fw-versions output should match the installed Intel Gaudi software versions.

         .. code-block::

            hl-smi --fw-versions

      - Execute hl-smi and confirm that the temperature shows a value greater than zero. If the temperature reads "0C," it indicates an issue with the card initialization. In this case, reboot the system and review the driver installation steps to ensure they were performed correctly.

         .. code-block::

            hl-smi

      - Run dmesg and ensure no errors are reported:

         .. code-block::

            dmesg | grep habana

      - Check if the SPI FW version matches the Intel Gaudi software driver version by running hl-smi below:

         .. code-block::

            hl-smi -L | grep SPI

      - Re-check all SW components by running the apt list command below:

         .. code-block::

            apt list --installed | grep habana


      - Delete the existing VM, create a new VM, and perform the above validations again:

- Login to Harvetser Box and Enable write-protect

   - Wiwynn Devices
      .. code-block:: bash

         #!/usr/bin/bash

         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x00 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x00 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x01 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x01 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x02 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x02 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x03 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x03 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x04 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x04 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x05 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x05 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x06 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x06 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x07 0x25 0x01 0x8 0x26
         sleep 2
         sudo ipmitool -b 0x0a -t 0x22 raw 0x3c 0x1e 0x07 0x25 0x01 0x8 0x26

   
   - Supermicro Devices
      .. code-block:: bash

       #!/usr/bin/bash

         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x40 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x40 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x41 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x41 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x42 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x42 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x43 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x43 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x44 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x44 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x45 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x45 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x46 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x46 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x47 2 0x4a 1 0x8 0x26
         sleep 2
         sudo ipmitool raw 0x30 0x70 0xef 4 0x70 0x40 0xe6 0x47 2 0x4a 1 0x8 0x26


Rollback(if needed):
****************************

#. To rollback, we need to revert to the Gaudi2 1.13 version. Therefore, we must repeat the same list of activities outlined in the previous steps, using the **habanalabs-firmware-odm-1.13.0-463.amd64.deb** Debian archive files and the **V.13** Harvester image.